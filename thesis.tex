\documentclass[12pt,letterpaper]{book}

\usepackage{amssymb}
\usepackage{booktabs}
\usepackage[T1]{fontenc}
\usepackage[margin=1in]{geometry}
\usepackage{graphicx}
\usepackage[hidelinks]{hyperref}
\usepackage[mono=false]{libertine}
\usepackage{listings}
\usepackage{multirow}
\usepackage[numbers]{natbib}
\usepackage[libertine]{newtxmath}
\usepackage{subcaption}
\usepackage[svgnames]{xcolor}
\usepackage{xspace}

\newcommand{\chapquotes}{}
\newcommand{\Chap}{Chapter}
\newcommand{\chap}{chapter\xspace}
\newcommand{\paper}{thesis\xspace}
\newcommand{\Unix}{Unix\xspace}

\newcommand{\blacklist}[1][\xspace]{blocklist#1}
\newcommand{\whitelist}[1][\xspace]{allowlist#1}

\newcommand{\solb}[1]{{\color{magenta} TODO #1}}
\newcommand{\thesis}[1]{\solb{THESIS #1}}

\renewcommand{\contentsname}{Table of Contents}
\renewcommand{\lstlistlistingname}{List of Listings}

\lstset{captionpos=b,
	basicstyle=\ttfamily,
	keywordstyle=\color{Blue},
	commentstyle=\color{Green},
	columns=flexible,
	language=C++,
	upquote=true
}

\bibliographystyle{abbrvnat}

\newcommand{\ms}[1]{#1 ms}
\newcommand{\us}[1]{#1 \textmu{}s}

\newcommand{\attribchapquote}{}
\newcommand{\gapchapquote}{}
\newcommand{\widthchapquote}{3in}
\newenvironment{chapquote}[2][1in]{
	\renewcommand{\attribchapquote}{#2}
	\renewcommand{\gapchapquote}{#1}
	\vspace{-2in}
	\begin{flushright}
	{\Large ``}
}{
	{\Large ''} \\
	--- \attribchapquote \\
	\rule{\widthchapquote}{1pt}
	\end{flushright}
	\vspace{\gapchapquote}
}

\makeatletter
\let\includegraphics@\includegraphics
\renewcommand{\includegraphics}[2][]{\includegraphics@[#1]{\includegraphicsdir#2}}
\newcommand{\includegraphicsdir}{}

\let\input@\input
\renewcommand{\input}[2][.]{
	\renewcommand{\includegraphicsdir}{#1/}
	\input@{#1/#2}
	\renewcommand{\includegraphicsdir}{}
}

\let\figure@\figure
\let\endfigure@\endfigure
\let\includegraphixs@\includegraphics
\let\caption@\caption
\let\label@\label
\newenvironment{swallowfigures}{
	\renewenvironment{figure}{
		\renewcommand{\includegraphics}[2][]{}
		\renewcommand{\caption}[1]{}
		\renewcommand{\label}[1]{}
	}{
		\let\includegraphics\includegraphixs@
		\let\caption\caption@
		\let\label\label@
	}
}{
	\let\figure\figure@
	\let\endfigure\endfigure@
}

\let\section@\section
\newenvironment{swallowsections}{
	\renewcommand{\section}[1]{}
}{
	\let\section\section@
}

\let\subsection@\subsection
\newenvironment{swallowsubsections}{
	\renewcommand{\subsection}[1]{}
}{
	\let\subsection\subsection@
}

\newenvironment{promotesubsections}{
	\renewcommand{\subsection}[1]{\section@{##1}}
}{
	\let\subsection\subsection@
}
\makeatother

\newenvironment{abstract}{}{}

\newcommand{\mytableistoobig}{}

\begin{document}

\makeatletter
\let\label@\label
\let\ref@\ref
\newenvironment{namespacereferences}[1]{
	\renewcommand{\label}[1]{\label@{#1##1}}
	\renewcommand{\ref}[1]{\ref@{#1##1}}
}{
	\let\label\label@
	\let\ref\ref@
}
\makeatother

\frontmatter

\begin{titlepage}
\begin{center}
	\vspace*{\fill}

	\textbf{\Large Lightweight Preemptible Functions} \\
	A thesis \\
	\hfill \\
	{\large Sol Boucher} \\
	\today \\

	\vspace{1in}

	\textbf{Thesis committee:} \\
	David G.\@ Andersen, \textit{chair} \\
	Adam Belay \\
	Michael Kaminsky \\
	Brandon Lucia \\

	\vspace{\fill}

	\textit{Submitted in partial fulfillment of the requirements \\
	for the degree of Doctor of Philosophy} \\
	\hfill \\
	Computer Science Department \\
	School of Computer Science \\
	Carnegie Mellon University \\
	Pittsburgh, PA 15213 \\
\end{center}
\end{titlepage}

\cleardoublepage
\addcontentsline{toc}{chapter}{\contentsname}
\tableofcontents
\listoffigures
\addcontentsline{toc}{chapter}{\listfigurename}
\listoftables
\addcontentsline{toc}{chapter}{\listtablename}
\lstlistoflistings
\addcontentsline{toc}{chapter}{\lstlistlistingname}

\chapter{TODOs THESIS}


\section{Lessons for system builders (slides)}

Resuming is a useful feature that is cheap, but introduces concurrency.
Cannot get CPU time isolation without memory isolation.
Design abstractions modularly and with an eye to simple use cases (e.g., \textit{libgotcha} as a separate
runtime with a very small control API, things listed in the note on design).
Treat debuggability as a first-order concern (e.g., permit disabling features that interfere at
runtime, test and maintain support for running under debugging and diagnostic tools).


\input{foreword}


\mainmatter

\input{intro}
\input{functions}
\input{gotcha}
\input{safety}
\input{inger}
\input{ingerc}
\input{turquoise}

\renewcommand{\paper}{chapter\xspace}
\input{microservices}
\renewcommand{\paper}{thesis\xspace}

\input{concl}


\backmatter

\chapter{Proposed work}

\solb{Other libinger use:\@ resource limits besides wall-clock time}

\solb{Other libgotcha uses:\@ aspect-oriented programming, multiple library versions}

\begin{swallowsections}
\input[functions]{concl}
\end{swallowsections}


\section{Remaining work}

I propose extending the work already completed in all three of the following ways:

\paragraph{Automatic selection and variation of timer frequency}
For simplicity, the current \textit{libinger} implementation subscribes to timer
signals spaced a globally constant interval apart throughout the entire duration of
each preemptible function.  To improve efficiency while preserving preemption
granularity, I plan to dynamically determine this interval based on the requested
timeout.  For long-running functions, this will include delaying the first of these
signals until shortly before the timeout would expire.  Maintaining accuracy across
multiple CPUs will probably require building in a calibration routine to infer
configuration parameters.

\paragraph{Support OpenSSL and benchmark hyper with HTTPS}
Earlier in \textit{libgotcha}'s development history, it was able to run nginx with
OpenSSL.  Recent attempts at getting hyper to run with OpenSSL have ended in crashes,
yet this configuration is desirable for measurement because it exhibits a far greater
number of dynamic function calls, of which \textit{libgotcha} alters the performance
characteristics.  I aim to support and benchmark the configuration, which will likely
involve regression testing using the old nginx setup.

\hfill \\
\noindent
Additionally, I will complete one of the following projects, as selected by the
committee:

\paragraph{Achieve even finer--grained preemption}
The \textit{Shinjuku} authors included IPI microbenchmarks that suggest it should be
possible for us to achieve interrupt latencies and spacing within a small constant
factor of theirs.  I could attempt to achieve this by reusing some of their
optimizations to POSIX contexts and adding a specialized timer signal delivery
mechanism to the kernel to reduce the number of ISR instructions at the expense of
generality.

\paragraph{Implement ``\textit{libingerOS}'' container framework}
Generalizing the serverless platform case study, it should be possible to generate a
utility that takes two or more position-independent executables and combines them
into a single process whose thread(s) are timeshared between the ``programs'' using
preemptible functions.  Obviously, this would only provide memory isolation for
programs implemented in memory-safe languages.  This would be implemented on top of
\textit{libinger} as a sample application.


\cleardoublepage
\addcontentsline{toc}{chapter}{Bibliography}
\bibliography{ref}

\end{document}
